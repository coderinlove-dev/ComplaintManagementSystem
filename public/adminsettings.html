<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard â€“ Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f6f8fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .admin-navbar {
      background: #34495e;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }
    .admin-navbar .logo {
      font-weight: 700;
      font-size: 1.4rem;
    }
    .admin-navbar .top-actions a {
      color: #fff;
      margin-left: 18px;
      text-decoration: none;
    }
    .dashboard-layout {
      display: flex;
      flex: 1 0 auto;
      min-height: 0;
    }
    .admin-sidebar {
      background: #223454;
      color: #c8d3e3;
      min-width: 200px;
      max-width: 240px;
      padding: 2rem 0 2rem 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .admin-sidebar h3 {
      margin-left: 2rem;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 1.4rem;
      color: #fff;
    }
    .admin-sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }
    .admin-sidebar li {
      margin-bottom: 1rem;
    }
    .admin-sidebar a {
      display: block;
      padding: 0.7rem 2rem;
      color: #c8d3e3;
      text-decoration: none;
      border-left: 3px solid transparent;
      transition: background 0.2s, border-color 0.2s;
    }
    .admin-sidebar a.active,
    .admin-sidebar a:hover {
      background: #293e63;
      border-left: 3px solid #3bb77e;
      color: #fff;
    }
    .admin-main-content {
      flex: 1;
      padding: 2rem 3vw;
      min-width: 0;
      background: #f6f8fa;
      display: flex;
      flex-direction: column;
      max-width: 950px;
    }
    .admin-section-title {
      font-size: 1.3rem;
      margin-bottom: 1.2rem;
      font-weight: 700;
      color: #223454;
      margin-top: 0;
    }
    .settings-group {
      background: #fff;
      border-radius: 9px;
      box-shadow: 0 2px 10px 0 rgba(60,80,120,0.06);
      padding: 1.7rem 2rem 1.2rem;
      margin-bottom: 2rem;
    }
    .settings-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #223454;
      margin-bottom: 1em;
    }
    .settings-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.1em;
    }
    .settings-row label {
      min-width: 180px;
      font-weight: 500;
      color: #444a52;
      margin-right: 1.5em;
      margin-bottom: 0.5em;
      max-width: 300px;
    }
    .settings-row input[type="text"],
    .settings-row input[type="password"],
    .settings-row input[type="number"],
    .settings-row select {
      font-size: 1rem;
      padding: 7px 14px;
      border: 1px solid #bbb;
      border-radius: 6px;
      min-width: 200px;
      max-width: 290px;
      background: #fcfcff;
      margin-right: 10px;
    }
    .settings-row input[type="file"] {
      margin-right: 10px;
    }
    .settings-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    .settings-row .desc {
      color: #888;
      font-size: 0.94em;
      margin-left: 5px;
      line-height: 1.6;
    }
    .settings-save-btn {
      background: #27ae60;
      color: #fff;
      font-size: 1rem;
      padding: 7px 28px;
      border-radius: 6px;
      border: 1px solid #1e8449;
      cursor: pointer;
      margin-top: 6px;
      margin-bottom: 0.8em;
      transition: background 0.2s;
    }
    .settings-save-btn:hover {
      background: #1e8449;
    }
    .settings-divider {
      border: none;
      border-top: 1.3px solid #d5d9e2;
      margin: 2rem 0 2.1rem 0;
    }
    @media (max-width: 900px) {
      .dashboard-layout { flex-direction: column;}
      .admin-sidebar { flex-direction: row; min-width: 0; max-width: none; padding: 0.7rem 0; min-height: unset;}
      .admin-sidebar ul { display: flex; flex-wrap: wrap; }
      .admin-sidebar li { margin-bottom: 0; }
      .admin-sidebar a { padding: 0.7rem 1.25rem;}
    }
    @media (max-width: 600px) {
      .admin-navbar, .admin-main-content { padding-left: 1vw; padding-right: 1vw; }
      .settings-group { padding: 1em 0.7em;}
      .settings-row label { min-width: 110px; max-width: 160px;}
      .settings-row input, .settings-row select { min-width: 120px;}
    }
  </style>
</head>
<body>
  <nav class="admin-navbar">
    <span class="logo">Admin Dashboard</span>
    <span class="top-actions">
      <a href="admin.html">Admin</a>
      <a href="logout.html">Log out</a>
    </span>
  </nav>
  <div class="dashboard-layout">
    <aside class="admin-sidebar">
      <h3>Navigation</h3>
      <ul>
        <li><a href="admin.html">Dashboard</a></li>
        <li><a href="adminuser.html">Users</a></li>
        <li><a href="admincomplaints.html">Complaints</a></li>
        <li><a href="adminstatistics.html">Statistics</a></li>
        <li><a href="adminsettings.html" class="active">Settings</a></li>
      </ul>
    </aside>
    <div class="admin-main-content">
      <div class="admin-section-title">Settings</div>

      <!-- Account & Security -->
      <form class="settings-group" id="formSecurity" autocomplete="off" onsubmit="saveSecurity(event)">
        <div class="settings-title">Account & Security</div>
        <div class="settings-row">
          <label for="adminNewPass">Change Password</label>
          <input type="password" id="adminNewPass" placeholder="New Password" autocomplete="new-password" />
        </div>
        <div class="settings-row">
          <label for="sessionTimeout">Session Timeout (mins)</label>
          <input type="number" min="5" max="240" id="sessionTimeout" value="30" />
          <span class="desc">Set time for inactivity logout</span>
        </div>
        <button class="settings-save-btn" type="submit">Save Security Settings</button>
      </form>
      <hr class="settings-divider" />

      <!-- User Management -->
      <form class="settings-group" id="formUserPrefs" autocomplete="off" onsubmit="saveUserPrefs(event)">
        <div class="settings-title">User Management Preferences</div>
        <div class="settings-row">
          <label for="staffApprovalNeeded">
            <input type="checkbox" id="staffApprovalNeeded" checked />
            Require admin approval for new staff
          </label>
        </div>
        <div class="settings-row">
          <label for="defaultUserRole">Default Role for New Users</label>
          <select id="defaultUserRole">
            <option value="Student">Student</option>
            <option value="Staff">Staff</option>
          </select>
        </div>
        <div class="settings-row">
          <label for="pwPolicy">Password Policy</label>
          <select id="pwPolicy">
            <option value="medium">Medium (min 8 chars, 1 number)</option>
            <option value="strong">Strong (min 10 chars, caps+number+symbol)</option>
          </select>
        </div>
        <button class="settings-save-btn" type="submit">Save User Preferences</button>
      </form>
      <hr class="settings-divider" />

      <!-- Complaint System -->
      <form class="settings-group" id="formComplaintSys" autocomplete="off" onsubmit="saveComplaintSys(event)">
        <div class="settings-title">Complaint System Settings</div>
        <div class="settings-row">
          <label for="defaultStatus">Default Status for New Complaints</label>
          <select id="defaultStatus">
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
          </select>
        </div>
        <div class="settings-row">
          <label for="categoriesEdit">Edit Complaint Categories</label>
          <input id="categoriesEdit" type="text" value="Facility, Management, Academic, IT, Other" />
          <span class="desc">Comma separated</span>
        </div>
        <div class="settings-row">
          <label for="slaDays">SLA: Mark as Overdue after (days)</label>
          <input type="number" min="1" max="90" id="slaDays" value="7" />
        </div>
        <div class="settings-row">
          <label for="attachLimitMb">Attachment Max Size (MB)</label>
          <input type="number" min="1" max="50" id="attachLimitMb" value="5" />
        </div>
        <button class="settings-save-btn" type="submit">Save Complaint System Settings</button>
      </form>
      <hr class="settings-divider" />

      <!-- Customization -->
      <form class="settings-group" id="formBrand" autocomplete="off" onsubmit="saveBrand(event)">
        <div class="settings-title">Customization & Branding</div>
        <div class="settings-row">
          <label for="setLogo">Upload Organization Logo</label>
          <input type="file" id="setLogo" accept="image/*" />
        </div>
        <div class="settings-row">
          <label for="systemName">System Display Name</label>
          <input type="text" id="systemName" value="XYZ College Complaint Portal" />
        </div>
        <div class="settings-row">
          <label for="colorTheme">Theme</label>
          <select id="colorTheme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="brand">Brand Color</option>
          </select>
        </div>
        <button class="settings-save-btn" type="submit">Save Customization</button>
      </form>
      <hr class="settings-divider" />

      <!-- Data & Help -->
      <form class="settings-group" id="formDataPolicy" autocomplete="off" onsubmit="saveDataPolicy(event)">
        <div class="settings-title">Data & Support</div>
        <div class="settings-row">
          <label for="retentionDays">Archive Data After (days)</label>
          <input type="number" min="7" max="9999" id="retentionDays" value="365" />
        </div>
        <div class="settings-row">
          <label for="privacyLevel">Privacy Level</label>
          <select id="privacyLevel">
            <option value="normal">Normal (admin/staff can see all details)</option>
            <option value="protected">Protected (hide user contact from non-admins)</option>
          </select>
        </div>
        <div class="settings-row">
          <label>Support Contact</label>
          <span class="desc"><a href="mailto:support@xyzcollege.com">support@xyzcollege.com</a> (Admin Helpdesk)</span>
        </div>
        <div class="settings-row">
          <label>User Guide</label>
          <span class="desc"><a href="#">View Documentation</a></span>
        </div>
        <button class="settings-save-btn" type="submit">Save Data Policy</button>
      </form>
    </div>
  </div>
 
<script>
async function showSavedMsg(form, msg = 'Settings saved!') {
  let el = document.createElement('div');
  el.textContent = msg;
  el.style.color = '#27ae60';
  el.style.marginTop = "8px";
  el.style.fontSize = "1rem";
  form.appendChild(el);
  setTimeout(() => { el.remove(); }, 1800);
}

// Prefill all forms with latest settings
async function loadAllSettings() {
  const token = localStorage.getItem('token');
  try {
    const res = await fetch('/api/admin/settings', { headers: { Authorization: "Bearer " + token } });
    if (!res.ok) return; // not logged in
    const settings = await res.json();
    // Security
    if (settings.session_timeout)
      document.getElementById('sessionTimeout').value = settings.session_timeout;
    // User Management
    if (settings.staff_approval_needed)
      document.getElementById('staffApprovalNeeded').checked = settings.staff_approval_needed === "1";
    if (settings.default_user_role)
      document.getElementById('defaultUserRole').value = settings.default_user_role;
    if (settings.password_policy)
      document.getElementById('pwPolicy').value = settings.password_policy;
    // Complaint System
    if (settings.default_complaint_status)
      document.getElementById('defaultStatus').value = settings.default_complaint_status;
    if (settings.complaint_categories)
      document.getElementById('categoriesEdit').value = settings.complaint_categories;
    if (settings.sla_days)
      document.getElementById('slaDays').value = settings.sla_days;
    if (settings.attachment_limit_mb)
      document.getElementById('attachLimitMb').value = settings.attachment_limit_mb;
    // Branding
    if (settings.system_name)
      document.getElementById('systemName').value = settings.system_name;
    if (settings.color_theme)
      document.getElementById('colorTheme').value = settings.color_theme;
    // Data Policy
    if (settings.data_retention_days)
      document.getElementById('retentionDays').value = settings.data_retention_days;
    if (settings.privacy_level)
      document.getElementById('privacyLevel').value = settings.privacy_level;
  } catch (e) {
    // You can show an error here if you wish
  }
}

// SECURITY SETTINGS: Password + session timeout
async function saveSecurity(e) {
  e.preventDefault();
  const form = document.getElementById('formSecurity');
  const token = localStorage.getItem('token');
  const password = document.getElementById('adminNewPass').value;
  const sessionTimeout = document.getElementById('sessionTimeout').value;
  try {
    const res = await fetch('/api/admin/settings/security', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: "Bearer " + token },
      body: JSON.stringify({ password, sessionTimeout })
    });
    if (!res.ok) throw new Error((await res.json()).message || 'Save failed');
    showSavedMsg(form, "Security settings saved!");
    document.getElementById('adminNewPass').value = '';
  } catch (err) {
    showSavedMsg(form, "Error: " + (err.message || "Could not save."));
  }
}

// USER MANAGEMENT (preferences)
async function saveUserPrefs(e) {
  e.preventDefault();
  const form = document.getElementById('formUserPrefs');
  const token = localStorage.getItem('token');
  const staffApprovalNeeded = document.getElementById('staffApprovalNeeded').checked;
  const defaultUserRole = document.getElementById('defaultUserRole').value;
  const pwPolicy = document.getElementById('pwPolicy').value;
  try {
    const res = await fetch('/api/admin/settings/userprefs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: "Bearer " + token },
      body: JSON.stringify({ staffApprovalNeeded, defaultUserRole, pwPolicy })
    });
    if (!res.ok) throw new Error((await res.json()).message || 'Save failed');
    showSavedMsg(form, "User preferences saved!");
  } catch (err) {
    showSavedMsg(form, "Error: " + (err.message || "Could not save."));
  }
}

// COMPLAINT SYSTEM
async function saveComplaintSys(e) {
  e.preventDefault();
  const form = document.getElementById('formComplaintSys');
  const token = localStorage.getItem('token');
  const defaultStatus = document.getElementById('defaultStatus').value;
  const categories = document.getElementById('categoriesEdit').value;
  const slaDays = document.getElementById('slaDays').value;
  const attachLimitMb = document.getElementById('attachLimitMb').value;
  try {
    const res = await fetch('/api/admin/settings/complaintsys', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: "Bearer " + token },
      body: JSON.stringify({ defaultStatus, categories, slaDays, attachLimitMb })
    });
    if (!res.ok) throw new Error((await res.json()).message || 'Save failed');
    showSavedMsg(form, "Complaint system settings saved!");
  } catch (err) {
    showSavedMsg(form, "Error: " + (err.message || "Could not save."));
  }
}

// BRANDING
async function saveBrand(e) {
  e.preventDefault();
  const form = document.getElementById('formBrand');
  const token = localStorage.getItem('token');
  const systemName = document.getElementById('systemName').value;
  const colorTheme = document.getElementById('colorTheme').value;
  // Skipping logo upload for simplicity (needs formData/multipart)
  try {
    const res = await fetch('/api/admin/settings/brand', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: "Bearer " + token },
      body: JSON.stringify({ systemName, colorTheme })
    });
    if (!res.ok) throw new Error((await res.json()).message || 'Save failed');
    showSavedMsg(form, "Branding saved!");
  } catch (err) {
    showSavedMsg(form, "Error: " + (err.message || "Could not save."));
  }
}

// DATA POLICY
async function saveDataPolicy(e) {
  e.preventDefault();
  const form = document.getElementById('formDataPolicy');
  const token = localStorage.getItem('token');
  const retentionDays = document.getElementById('retentionDays').value;
  const privacyLevel = document.getElementById('privacyLevel').value;
  try {
    const res = await fetch('/api/admin/settings/datapolicy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: "Bearer " + token },
      body: JSON.stringify({ retentionDays, privacyLevel })
    });
    if (!res.ok) throw new Error((await res.json()).message || 'Save failed');
    showSavedMsg(form, "Data policy saved!");
  } catch (err) {
    showSavedMsg(form, "Error: " + (err.message || "Could not save."));
  }
}

// When page loads, prefill all forms from backend
document.addEventListener('DOMContentLoaded', loadAllSettings);
</script>

</body>
</html>
